- name: Run smoke tests
  shell: bash
  run: |
    set -euo pipefail

    # Ensure groqbash binary is executed directly and environment is explicit
    GROQ_BIN=""
    if [ -x "./bin/groqbash" ]; then
      GROQ_BIN="./bin/groqbash"
    elif [ -x "./groqbash" ]; then
      GROQ_BIN="./groqbash"
    elif command -v groqbash >/dev/null 2>&1; then
      GROQ_BIN="$(command -v groqbash)"
    else
      echo "FAIL: groqbash non trovato"
      exit 2
    fi

    # Export env vars groqbash may rely on
    export TMPDIR="${TMPDIR:-${RUNNER_TEMP:-/tmp}}"
    export TMP="${TMP:-$TMPDIR}"
    export TEMP="${TEMP:-$TMPDIR}"
    export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
    mkdir -p "$TMPDIR" "$XDG_CONFIG_HOME/groq"
    chmod 700 "$TMPDIR" || true

    # Ensure whitelist model matches tests/good.json
    printf '%s\n' "llama-3.3-70b-versatile" > "$XDG_CONFIG_HOME/groq/models.txt"
    chmod 600 "$XDG_CONFIG_HOME/groq/models.txt" || true

    # Run groqbash directly and capture output
    OUTFILE="$(mktemp)"
    set +e
    "$GROQ_BIN" --dry-run tests/good.json >"$OUTFILE" 2>&1
    RC=$?
    set -e

    if [ $RC -ne 0 ]; then
      echo "FAIL: --dry-run ha restituito exit code $RC"
      if [ -s "$OUTFILE" ]; then
        echo "Output (first 200 lines):"
        sed -n '1,200p' "$OUTFILE"
      else
        echo "Output vuoto."
      fi
      rm -f "$OUTFILE"
      exit 1
    fi

    echo "OK: --dry-run completato con exit code 0"
    echo "Output (first 200 lines):"
    sed -n '1,200p' "$OUTFILE"
    rm -f "$OUTFILE"
